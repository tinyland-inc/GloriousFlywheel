# Attic Cache - direnv configuration
# ===================================
#
# This file configures the development environment using direnv and Nix.
# It automatically loads the Nix devShell and sets up environment variables.
#
# Prerequisites:
#   - direnv (brew install direnv)
#   - nix-direnv (recommended, for faster shell loading)
#   - Nix with flakes enabled
#
# Setup:
#   1. Install direnv: brew install direnv
#   2. Hook into your shell: eval "$(direnv hook zsh)"  # or bash
#   3. Allow this directory: direnv allow
#
# Optional .env file:
#   Create a .env file (gitignored) for local secrets:
#     TF_HTTP_PASSWORD=glpat-your-token-here
#     KUBE_CONTEXT=bates-ils/projects/kubernetes/gitlab-agents:beehive

# =============================================================================
# Nix Integration
# =============================================================================

# Use nix-direnv if available (faster shell loading with caching)
if has nix_direnv_version; then
  # nix-direnv is installed - use cached devShell
  nix_direnv_version 3.0.0
  use flake
else
  # Fallback to standard flake loading
  use flake
fi

# =============================================================================
# Environment Variables
# =============================================================================

# Load .env file if it exists (for local secrets like TF_HTTP_PASSWORD)
dotenv_if_exists

# Load organization config helpers
if [ -f scripts/lib/config.sh ]; then
  source scripts/lib/config.sh
fi

# Default environment (beehive = dev, rigel = staging/prod)
export ENV="${ENV:-beehive}"

# Organization config file
ORG_CONFIG="${ORG_CONFIG:-config/organization.yaml}"

# Kubernetes context based on environment (loaded from organization config)
if command -v yq &>/dev/null && [ -f "$ORG_CONFIG" ]; then
  export KUBE_CONTEXT="${KUBE_CONTEXT:-$(yq ".clusters[] | select(.name == \"$ENV\") | .context" "$ORG_CONFIG" 2>/dev/null || yq '.clusters[0].context' "$ORG_CONFIG")}"
  export KUBE_INGRESS_BASE_DOMAIN="${KUBE_INGRESS_BASE_DOMAIN:-$(yq ".clusters[] | select(.name == \"$ENV\") | .domain" "$ORG_CONFIG" 2>/dev/null || yq '.clusters[0].domain' "$ORG_CONFIG")}"
else
  # Fallback if yq not available or config missing
  if [ "$ENV" = "rigel" ]; then
    export KUBE_CONTEXT="${KUBE_CONTEXT:-bates-ils/projects/kubernetes/gitlab-agents:rigel}"
    export KUBE_INGRESS_BASE_DOMAIN="${KUBE_INGRESS_BASE_DOMAIN:-rigel.bates.edu}"
  else
    export KUBE_CONTEXT="${KUBE_CONTEXT:-bates-ils/projects/kubernetes/gitlab-agents:beehive}"
    export KUBE_INGRESS_BASE_DOMAIN="${KUBE_INGRESS_BASE_DOMAIN:-beehive.bates.edu}"
  fi
fi

# Namespace configuration (loaded from organization config)
if command -v yq &>/dev/null && [ -f "$ORG_CONFIG" ]; then
  export NAMESPACE="${NAMESPACE:-$(yq ".namespaces.attic.$ENV" "$ORG_CONFIG" 2>/dev/null || echo "attic-cache")}"
else
  export NAMESPACE="${NAMESPACE:-attic-cache}"
fi

# Attic configuration (auth-free mode for Bates deployment)
export ATTIC_SERVER="${ATTIC_SERVER:-https://attic-cache.${KUBE_INGRESS_BASE_DOMAIN}}"
export ATTIC_CACHE="${ATTIC_CACHE:-main}"
export ATTIC_CONFIG_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/attic"

# =============================================================================
# Bazel Configuration
# =============================================================================

# Bazel disk cache directory
export BAZEL_CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/bazel"

# Use workspace-specific output base to avoid conflicts with other projects
export BAZEL_OUTPUT_BASE="${BAZEL_CACHE_DIR}/attic-cache-output"

# =============================================================================
# OpenTofu Configuration
# =============================================================================

# Suppress color in non-interactive environments
if [ ! -t 1 ]; then
  export TF_CLI_ARGS="-no-color"
fi

# Default to non-interactive mode (can be overridden)
export TF_INPUT="${TF_INPUT:-false}"

# =============================================================================
# Project Layout
# =============================================================================

# Create project-specific bin directory for local scripts/tools
layout_dir=$(direnv_layout_dir)
mkdir -p "$layout_dir/bin"
PATH_add "$layout_dir/bin"

# Add scripts directory to PATH
PATH_add scripts

# =============================================================================
# File Watches
# =============================================================================

# Reload when these files change
watch_file flake.nix
watch_file flake.lock
watch_file .bazelversion
watch_file nix/shell.nix

# Watch tofu module changes
watch_dir tofu/modules

# Watch app package.json for dependency changes
watch_file app/package.json

# =============================================================================
# Kubernetes Context Switching (Optional Helper)
# =============================================================================

# Helper function to switch environments
# Usage: switch_env beehive  OR  switch_env rigel
switch_env() {
  local target_env="${1:-beehive}"
  local org_config="${ORG_CONFIG:-config/organization.yaml}"

  export ENV="$target_env"

  if command -v yq &>/dev/null && [ -f "$org_config" ]; then
    export KUBE_CONTEXT="$(yq ".clusters[] | select(.name == \"$target_env\") | .context" "$org_config" 2>/dev/null)"
    export KUBE_INGRESS_BASE_DOMAIN="$(yq ".clusters[] | select(.name == \"$target_env\") | .domain" "$org_config" 2>/dev/null)"
    export ATTIC_SERVER="https://attic-cache.${KUBE_INGRESS_BASE_DOMAIN}"
    echo "Switched to $target_env (${KUBE_INGRESS_BASE_DOMAIN})"
  else
    # Fallback for backward compatibility
    if [ "$target_env" = "rigel" ]; then
      export KUBE_CONTEXT="bates-ils/projects/kubernetes/gitlab-agents:rigel"
      export KUBE_INGRESS_BASE_DOMAIN="rigel.bates.edu"
      export ATTIC_SERVER="https://attic-cache.rigel.bates.edu"
      echo "Switched to rigel (staging/prod)"
    else
      export KUBE_CONTEXT="bates-ils/projects/kubernetes/gitlab-agents:beehive"
      export KUBE_INGRESS_BASE_DOMAIN="beehive.bates.edu"
      export ATTIC_SERVER="https://attic-cache.beehive.bates.edu"
      echo "Switched to beehive (dev)"
    fi
  fi
}
export -f switch_env

# =============================================================================
# GitLab Agent Context (for kubectl)
# =============================================================================

# Set kubectl context to use GitLab Agent
# This enables kubectl commands through the GitLab Kubernetes Agent
setup_kubectl_context() {
  if command -v kubectl &>/dev/null; then
    # The GitLab Agent context is set via KUBE_CONTEXT
    # kubectl will use it when the agent is properly configured
    echo "Kubectl context: ${KUBE_CONTEXT}"
    echo "Run 'kubectl config use-context <context>' if needed"
  fi
}

# =============================================================================
# Development Hints
# =============================================================================

# Show a brief hint on shell entry (only in interactive shells)
if [ -t 1 ]; then
  echo ""
  echo "Attic Cache Development Environment"
  echo "===================================="
  echo "Environment: ${ENV} (${KUBE_INGRESS_BASE_DOMAIN})"
  echo ""
  echo "Quick commands:"
  echo "  just              - List all available tasks"
  echo "  just check        - Run all validations"
  echo "  just info         - Show environment config"
  echo "  switch_env rigel  - Switch to rigel cluster"
  echo ""
fi
