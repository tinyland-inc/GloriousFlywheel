# Attic Stack - OpenTofu Commands
# ================================
#
# Local task automation for the Attic stack.
# Delegates to the root Justfile for common operations.
#
# NOTE: For most operations, use the root Justfile instead:
#   just attic-init        # Initialize
#   just attic-plan        # Plan
#   just attic-deploy      # Full deploy
#
# This file exists for convenience when working directly in this directory.
#
# Usage from this directory:
#   just init         # Initialize OpenTofu
#   just plan         # Plan changes
#   just apply        # Apply changes
#
# Environment Selection:
#   ENV=prod just plan    # Target production cluster
#   ENV=dev just plan     # Target dev (default)

# Default recipe - list available commands
default:
    @just --list

# =============================================================================
# Configuration
# =============================================================================

# Environment: dev or prod (override with ENV=prod)
env := env_var_or_default("ENV", "dev")

# Derived settings
tfvars := env + ".tfvars"
state_name := "attic-" + env

# GitLab project settings (override with GITLAB_PROJECT)
gitlab_project := env_var_or_default("GITLAB_PROJECT", "YOUR_PROJECT_ID")
gitlab_api := "https://gitlab.com/api/v4"

# Kubernetes context (override with KUBE_CONTEXT)
kube_context := env_var_or_default("KUBE_CONTEXT", "your-org/project/agents:your-cluster")

# =============================================================================
# Core Commands (Local Execution)
# =============================================================================

# Initialize OpenTofu with GitLab backend
init:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "=== Initializing Attic Stack ({{env}}) ==="
    echo "State: {{state_name}}"

    if [ -z "${TF_HTTP_PASSWORD:-}" ]; then
        echo "ERROR: TF_HTTP_PASSWORD not set"
        echo "Set it to your GitLab PAT with 'api' scope:"
        echo "  export TF_HTTP_PASSWORD='glpat-...'"
        exit 1
    fi

    tofu init -reconfigure \
        -backend-config="address={{gitlab_api}}/projects/{{gitlab_project}}/terraform/state/{{state_name}}" \
        -backend-config="lock_address={{gitlab_api}}/projects/{{gitlab_project}}/terraform/state/{{state_name}}/lock" \
        -backend-config="unlock_address={{gitlab_api}}/projects/{{gitlab_project}}/terraform/state/{{state_name}}/lock" \
        -backend-config="lock_method=POST" \
        -backend-config="unlock_method=DELETE" \
        -backend-config="username=gitlab-ci-token" \
        -backend-config="password=${TF_HTTP_PASSWORD}"

# Plan changes
plan:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "=== Planning Attic ({{env}}) ==="
    tofu plan \
        -var="cluster_context={{kube_context}}" \
        -var-file="{{tfvars}}" \
        -out=tfplan
    echo ""
    echo "Plan saved to: tfplan"
    echo "Run 'just apply' to apply changes"

# Apply changes (uses saved plan)
apply:
    #!/usr/bin/env bash
    set -euo pipefail
    if [ ! -f tfplan ]; then
        echo "ERROR: No plan file found. Run 'just plan' first."
        exit 1
    fi
    echo "=== Applying Attic ({{env}}) ==="
    tofu apply tfplan

# =============================================================================
# Compound Workflows
# =============================================================================

# Plan and apply in one step
deploy: plan apply

# Full deploy cycle: init, plan, deploy
full: init plan apply

# =============================================================================
# Destruction (with safety)
# =============================================================================

# Destroy infrastructure (with confirmation)
destroy:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "WARNING: This will destroy all Attic resources in {{env}}!"
    read -p "Type 'yes' to confirm: " confirm
    if [ "$confirm" != "yes" ]; then
        echo "Aborted."
        exit 1
    fi
    tofu destroy \
        -var="cluster_context={{kube_context}}" \
        -var-file="{{tfvars}}"

# =============================================================================
# State Management
# =============================================================================

# Show current state
state:
    tofu state list

# Pull state for inspection
state-pull:
    tofu state pull | jq .

# Refresh state from infrastructure
refresh:
    tofu refresh -var="cluster_context={{kube_context}}" -var-file="{{tfvars}}"

# Unlock stuck state
state-unlock:
    #!/usr/bin/env bash
    echo "Unlocking state: {{state_name}}"
    curl -X DELETE -H "PRIVATE-TOKEN: ${TF_HTTP_PASSWORD}" \
        "{{gitlab_api}}/projects/{{gitlab_project}}/terraform/state/{{state_name}}/lock"

# =============================================================================
# Validation & Utilities
# =============================================================================

# Validate configuration
validate:
    tofu validate

# Format files
fmt:
    tofu fmt -recursive

# Check formatting
fmt-check:
    tofu fmt -recursive -check -diff

# Show outputs
output:
    tofu output

# Generate dependency graph
graph:
    tofu graph | dot -Tsvg > graph.svg
    @echo "Graph saved to: graph.svg"

# Clean up local files
clean:
    rm -rf .terraform/ tfplan plan.json graph.svg

# Show environment info
info:
    @echo "Stack:       attic"
    @echo "Environment: {{env}}"
    @echo "State name:  {{state_name}}"
    @echo "Tfvars:      {{tfvars}}"
    @echo "K8s context: {{kube_context}}"
