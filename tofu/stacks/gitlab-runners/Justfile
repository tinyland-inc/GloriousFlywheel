# GitLab Runners Stack - OpenTofu Commands
# =========================================
#
# Local task automation for deploying GitLab Runners to Kubernetes clusters.
#
# NOTE: For most operations, use the root Justfile instead:
#   just runners-init       # Initialize
#   just runners-plan       # Plan
#   just runners-deploy     # Full deploy
#   just runners-status     # Check status
#
# This file exists for convenience when working directly in this directory.
#
# Usage from this directory:
#   just init         # Initialize OpenTofu
#   just plan         # Plan deployment
#   just deploy       # Apply deployment
#   just status       # Check runner status
#
# Environment Selection:
#   ENV=prod just plan    # Target production cluster
#   ENV=dev just plan     # Target dev (default)

# Default recipe - list available commands
default:
    @just --list

# =============================================================================
# Configuration
# =============================================================================

# Environment: dev or prod (override with ENV=prod)
env := env_var_or_default("ENV", "dev")
tfvars := env + ".tfvars"
namespace := "gitlab-runners"

# GitLab project settings (override with GITLAB_PROJECT)
gitlab_project := env_var_or_default("GITLAB_PROJECT", "YOUR_PROJECT_ID")
gitlab_api := "https://gitlab.com/api/v4"

# Kubernetes context (override with KUBE_CONTEXT)
kube_context := env_var_or_default("KUBE_CONTEXT", "your-org/project/agents:your-cluster")

# State name for GitLab backend
state_name := "gitlab-runners-" + env

# =============================================================================
# Deployment Commands
# =============================================================================

# Initialize OpenTofu with GitLab backend
init:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "=== Initializing GitLab Runners ({{env}}) ==="

    if [ -z "${TF_HTTP_PASSWORD:-}" ]; then
        echo "WARNING: TF_HTTP_PASSWORD not set (required for GitLab state backend)"
        echo "For local development, run: export TF_HTTP_PASSWORD='glpat-...'"
    fi

    tofu init -reconfigure \
        -backend-config="address={{gitlab_api}}/projects/{{gitlab_project}}/terraform/state/{{state_name}}" \
        -backend-config="lock_address={{gitlab_api}}/projects/{{gitlab_project}}/terraform/state/{{state_name}}/lock" \
        -backend-config="unlock_address={{gitlab_api}}/projects/{{gitlab_project}}/terraform/state/{{state_name}}/lock" \
        -backend-config="lock_method=POST" \
        -backend-config="unlock_method=DELETE" \
        -backend-config="username=gitlab-ci-token" \
        -backend-config="password=${TF_HTTP_PASSWORD:-}"

# Plan deployment
plan:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "=== Planning GitLab Runners ({{env}}) ==="
    tofu plan \
        -var="cluster_context={{kube_context}}" \
        -var-file="{{tfvars}}" \
        -out=tfplan
    echo ""
    echo "Plan saved to: tfplan"
    echo "Run 'just apply' to apply changes"

# Apply deployment (uses saved plan)
apply:
    #!/usr/bin/env bash
    set -euo pipefail
    if [ ! -f tfplan ]; then
        echo "ERROR: No plan file found. Run 'just plan' first."
        exit 1
    fi
    echo "=== Applying GitLab Runners ({{env}}) ==="
    tofu apply tfplan

# Plan and apply in one step
deploy: plan apply

# Full deploy cycle: init, plan, deploy
full: init plan apply

# =============================================================================
# Destruction (with safety)
# =============================================================================

# Destroy runners (with confirmation)
destroy:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "WARNING: This will destroy all GitLab runners in {{namespace}} ({{env}})!"
    read -p "Type 'yes' to confirm: " confirm
    if [ "$confirm" != "yes" ]; then
        echo "Aborted."
        exit 1
    fi
    tofu destroy \
        -var="cluster_context={{kube_context}}" \
        -var-file="{{tfvars}}"

# Force destroy (no confirmation - use with caution)
destroy-force:
    tofu destroy -var="cluster_context={{kube_context}}" -var-file={{tfvars}} -auto-approve

# =============================================================================
# Status Commands
# =============================================================================

# Show runner status
status:
    @echo "=== GitLab Runners in {{namespace}} ({{env}}) ==="
    @kubectl get pods -n {{namespace}} -l app=gitlab-runner 2>/dev/null || echo "No runner pods found"
    @echo ""
    @echo "=== Deployments ==="
    @kubectl get deployments -n {{namespace}} 2>/dev/null || echo "No deployments found"
    @echo ""
    @echo "=== Helm Releases ==="
    @helm list -n {{namespace}} 2>/dev/null || echo "No helm releases found"

# Show runner logs
logs runner="nix-runner":
    kubectl logs -n {{namespace}} -l release={{runner}} -f --tail=100

# Show all runner logs
logs-all:
    kubectl logs -n {{namespace}} -l app=gitlab-runner -f --tail=100

# Exec into runner pod
exec runner="nix-runner":
    kubectl exec -it -n {{namespace}} $(kubectl get pod -n {{namespace}} -l release={{runner}} -o jsonpath='{.items[0].metadata.name}') -- /bin/sh

# Describe runner pods
describe runner="nix-runner":
    kubectl describe pod -n {{namespace}} -l release={{runner}}

# Get events
events:
    kubectl get events -n {{namespace}} --sort-by='.lastTimestamp'

# =============================================================================
# Validation & Utilities
# =============================================================================

# Validate configuration
validate:
    tofu validate

# Format files
fmt:
    tofu fmt -recursive

# Check formatting without changes
fmt-check:
    tofu fmt -recursive -check

# =============================================================================
# State Management
# =============================================================================

# Show current state
state:
    tofu state list

# Refresh state
refresh:
    tofu refresh -var="cluster_context={{kube_context}}" -var-file={{tfvars}}

# Unlock stuck state
state-unlock:
    #!/usr/bin/env bash
    echo "Unlocking state: {{state_name}}"
    curl -X DELETE -H "PRIVATE-TOKEN: ${TF_HTTP_PASSWORD}" \
        "{{gitlab_api}}/projects/{{gitlab_project}}/terraform/state/{{state_name}}/lock"

# Clean up local files
clean:
    rm -rf .terraform/ tfplan plan.json graph.svg

# =============================================================================
# Debugging
# =============================================================================

# Check runner registration in GitLab (requires GITLAB_TOKEN)
check-registration:
    @echo "Checking runner registration..."
    @if [ -n "$$GITLAB_TOKEN" ]; then \
        curl -s --header "PRIVATE-TOKEN: $$GITLAB_TOKEN" \
            "https://gitlab.com/api/v4/projects/$$PROJECT_ID/runners" | \
            jq '.[] | {id, description, status, tags}'; \
    else \
        echo "Set GITLAB_TOKEN and PROJECT_ID environment variables"; \
    fi

# Show environment info
info:
    @echo "Stack:       gitlab-runners"
    @echo "Environment: {{env}}"
    @echo "State name:  {{state_name}}"
    @echo "Namespace:   {{namespace}}"
    @echo "Tfvars:      {{tfvars}}"
    @echo "K8s context: {{kube_context}}"
