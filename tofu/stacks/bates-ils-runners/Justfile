# Bates ILS Runners Stack - OpenTofu Commands
# =============================================
#
# Task automation for deploying unified GitLab Runners for the bates-ils group.
#
# Usage:
#   just init         # Initialize OpenTofu
#   just plan         # Plan deployment
#   just deploy       # Apply deployment
#   just status       # Check runner status
#
# Environment Selection:
#   ENV=rigel just plan    # Target rigel cluster
#   ENV=beehive just plan  # Target beehive (default)

# Default recipe - list available commands
default:
    @just --list

# =============================================================================
# Configuration
# =============================================================================

# Environment: beehive (dev) or rigel (staging/prod)
env := env_var_or_default("ENV", "beehive")
tfvars := env + ".tfvars"
namespace := "bates-ils-runners"

# GitLab project settings
gitlab_project := "78189586"
gitlab_api := "https://gitlab.com/api/v4"

# Kubernetes context (GitLab Agent)
kube_context := if env == "beehive" {
    "bates-ils/projects/kubernetes/gitlab-agents:beehive"
} else {
    "bates-ils/projects/kubernetes/gitlab-agents:rigel"
}

# State name for GitLab backend
state_name := "bates-ils-runners-" + env

# =============================================================================
# Deployment Commands
# =============================================================================

# Initialize OpenTofu with GitLab backend
init:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "=== Initializing Bates ILS Runners ({{env}}) ==="

    if [ -z "${TF_HTTP_PASSWORD:-}" ]; then
        echo "WARNING: TF_HTTP_PASSWORD not set (required for GitLab state backend)"
        echo "For local development, run: export TF_HTTP_PASSWORD='glpat-...'"
    fi

    tofu init -reconfigure \
        -backend-config="address={{gitlab_api}}/projects/{{gitlab_project}}/terraform/state/{{state_name}}" \
        -backend-config="lock_address={{gitlab_api}}/projects/{{gitlab_project}}/terraform/state/{{state_name}}/lock" \
        -backend-config="unlock_address={{gitlab_api}}/projects/{{gitlab_project}}/terraform/state/{{state_name}}/lock" \
        -backend-config="lock_method=POST" \
        -backend-config="unlock_method=DELETE" \
        -backend-config="username=gitlab-ci-token" \
        -backend-config="password=${TF_HTTP_PASSWORD:-}"

# Plan deployment
plan:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "=== Planning Bates ILS Runners ({{env}}) ==="
    tofu plan \
        -var="cluster_context={{kube_context}}" \
        -var-file="{{tfvars}}" \
        -out=tfplan
    echo ""
    echo "Plan saved to: tfplan"
    echo "Run 'just apply' to apply changes"

# Apply deployment (uses saved plan)
apply:
    #!/usr/bin/env bash
    set -euo pipefail
    if [ ! -f tfplan ]; then
        echo "ERROR: No plan file found. Run 'just plan' first."
        exit 1
    fi
    echo "=== Applying Bates ILS Runners ({{env}}) ==="
    tofu apply tfplan

# Plan and apply in one step
deploy: plan apply

# Full deploy cycle: init, plan, deploy
full: init plan apply

# =============================================================================
# Destruction (with safety)
# =============================================================================

# Destroy runners (with confirmation)
destroy:
    #!/usr/bin/env bash
    set -euo pipefail
    echo "WARNING: This will destroy all Bates ILS runners in {{namespace}} ({{env}})!"
    read -p "Type 'yes' to confirm: " confirm
    if [ "$confirm" != "yes" ]; then
        echo "Aborted."
        exit 1
    fi
    tofu destroy \
        -var="cluster_context={{kube_context}}" \
        -var-file="{{tfvars}}"

# =============================================================================
# Status Commands
# =============================================================================

# Show runner status
status:
    @echo "=== Bates ILS Runners in {{namespace}} ({{env}}) ==="
    @echo ""
    @echo "=== Pods ==="
    @kubectl get pods -n {{namespace}} -o wide 2>/dev/null || echo "No pods found"
    @echo ""
    @echo "=== Deployments ==="
    @kubectl get deployments -n {{namespace}} 2>/dev/null || echo "No deployments found"
    @echo ""
    @echo "=== HPA ==="
    @kubectl get hpa -n {{namespace}} 2>/dev/null || echo "No HPA found"
    @echo ""
    @echo "=== Helm Releases ==="
    @helm list -n {{namespace}} 2>/dev/null || echo "No helm releases found"

# Show detailed status including resource usage
status-detailed:
    @echo "=== Bates ILS Runners Detailed Status ({{env}}) ==="
    @echo ""
    @echo "=== Pod Resources ==="
    @kubectl top pods -n {{namespace}} 2>/dev/null || echo "Metrics not available"
    @echo ""
    @echo "=== HPA Status ==="
    @kubectl describe hpa -n {{namespace}} 2>/dev/null | grep -A 5 "Metrics:" || echo "No HPA found"
    @echo ""
    @echo "=== PDB Status ==="
    @kubectl get pdb -n {{namespace}} 2>/dev/null || echo "No PDB found"

# Show runner logs
logs runner="bates-docker":
    kubectl logs -n {{namespace}} -l release={{runner}} -f --tail=100

# Show all runner logs
logs-all:
    kubectl logs -n {{namespace}} -l app=gitlab-runner -f --tail=100

# Exec into runner pod
exec runner="bates-docker":
    kubectl exec -it -n {{namespace}} $(kubectl get pod -n {{namespace}} -l release={{runner}} -o jsonpath='{.items[0].metadata.name}') -- /bin/sh

# Describe runner pods
describe runner="bates-docker":
    kubectl describe pod -n {{namespace}} -l release={{runner}}

# Get events
events:
    kubectl get events -n {{namespace}} --sort-by='.lastTimestamp'

# =============================================================================
# Per-Runner Commands
# =============================================================================

# Show docker runner status
docker-status:
    @echo "=== Docker Runner ==="
    @kubectl get pods,hpa,pdb -n {{namespace}} -l release=bates-docker 2>/dev/null

# Show dind runner status
dind-status:
    @echo "=== DinD Runner ==="
    @kubectl get pods,hpa,pdb -n {{namespace}} -l release=bates-dind 2>/dev/null

# Show rocky8 runner status
rocky8-status:
    @echo "=== Rocky 8 Runner ==="
    @kubectl get pods,hpa,pdb -n {{namespace}} -l release=bates-rocky8 2>/dev/null

# Show rocky9 runner status
rocky9-status:
    @echo "=== Rocky 9 Runner ==="
    @kubectl get pods,hpa,pdb -n {{namespace}} -l release=bates-rocky9 2>/dev/null

# Show nix runner status
nix-status:
    @echo "=== Nix Runner ==="
    @kubectl get pods,hpa,pdb -n {{namespace}} -l release=bates-nix 2>/dev/null

# =============================================================================
# Validation & Utilities
# =============================================================================

# Validate configuration
validate:
    tofu validate

# Format files
fmt:
    tofu fmt -recursive

# Check formatting without changes
fmt-check:
    tofu fmt -recursive -check

# =============================================================================
# State Management
# =============================================================================

# Show current state
state:
    tofu state list

# Refresh state
refresh:
    tofu refresh -var="cluster_context={{kube_context}}" -var-file={{tfvars}}

# Unlock stuck state
state-unlock:
    #!/usr/bin/env bash
    echo "Unlocking state: {{state_name}}"
    curl -X DELETE -H "PRIVATE-TOKEN: ${TF_HTTP_PASSWORD}" \
        "{{gitlab_api}}/projects/{{gitlab_project}}/terraform/state/{{state_name}}/lock"

# Clean up local files
clean:
    rm -rf .terraform/ tfplan plan.json graph.svg

# =============================================================================
# Debugging
# =============================================================================

# Check runner registration in GitLab
check-registration:
    @echo "Checking runner registration..."
    @if [ -n "$$GITLAB_TOKEN" ]; then \
        curl -s --header "PRIVATE-TOKEN: $$GITLAB_TOKEN" \
            "https://gitlab.com/api/v4/groups/$$BATES_ILS_GROUP_ID/runners" | \
            jq '.[] | {id, description, status, tags}'; \
    else \
        echo "Set GITLAB_TOKEN and BATES_ILS_GROUP_ID environment variables"; \
    fi

# Show environment info
info:
    @echo "Stack:       bates-ils-runners"
    @echo "Environment: {{env}}"
    @echo "State name:  {{state_name}}"
    @echo "Namespace:   {{namespace}}"
    @echo "Tfvars:      {{tfvars}}"
    @echo "K8s context: {{kube_context}}"

# Show runner summary
summary:
    @echo "=== Runner Summary ==="
    @echo ""
    @echo "Namespace: {{namespace}}"
    @echo "Environment: {{env}}"
    @echo ""
    @echo "Runner Types:"
    @echo "  - bates-docker: Standard builds (tags: docker, linux, amd64)"
    @echo "  - bates-dind: Container builds (tags: docker, dind, privileged)"
    @echo "  - bates-rocky8: RHEL 8 compat (tags: rocky8, rhel8, linux)"
    @echo "  - bates-rocky9: RHEL 9 compat (tags: rocky9, rhel9, linux)"
    @echo "  - bates-nix: Nix builds (tags: nix, flakes)"
