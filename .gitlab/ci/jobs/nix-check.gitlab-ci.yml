# Nix Flake Validation Jobs
# =========================
#
# These jobs validate the Nix flake configuration and run static analysis.
# Uses Alpine with Nix installed via DeterminateSystems installer since
# nixos/nix images lack /bin/sh required by GitLab Runner.

.nix-check-base:
  stage: validate
  image: alpine:3.21
  tags:
    - nix
  interruptible: true
  before_script:
    - apk add --no-cache curl xz bash git
    # Fix /nix permissions (runner mounts emptyDir which is world-writable)
    - chmod 755 /nix 2>/dev/null || true
    - curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install linux --no-confirm --init none
    - . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
    - nix --version
    # Dogfood: use our Attic cache as a substituter (pull cached builds)
    # Adds both stable and review URLs â€” nix silently skips unreachable ones
    - |
      CACHE_NAME="${ATTIC_CACHE:-main}"
      if [ -n "${ATTIC_SERVER:-}" ]; then
        echo "Configuring Attic substituter: ${ATTIC_SERVER}/${CACHE_NAME}"
        echo "extra-substituters = ${ATTIC_SERVER}/${CACHE_NAME}" >> /etc/nix/nix.conf
        echo "trusted-substituters = ${ATTIC_SERVER}/${CACHE_NAME}" >> /etc/nix/nix.conf
      fi
      if [ -n "${CI_COMMIT_REF_SLUG:-}" ]; then
        REVIEW_URL="https://${FIXED_SUBDOMAIN:-attic-cache}-${CI_COMMIT_REF_SLUG}.${KUBE_INGRESS_BASE_DOMAIN}/${CACHE_NAME}"
        echo "Also trying review cache: ${REVIEW_URL}"
        echo "extra-substituters = ${REVIEW_URL}" >> /etc/nix/nix.conf
        echo "trusted-substituters = ${REVIEW_URL}" >> /etc/nix/nix.conf
      fi

# Validate flake configuration
# NOTE: allow_failure - first build populates Attic cache, subsequent builds are fast
nix:flake-check:
  extends: .nix-check-base
  script:
    - echo "Running nix flake check..."
    - nix flake check --print-build-logs
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Static analysis with statix
nix:statix:
  extends: .nix-check-base
  script:
    - echo "Running statix linter..."
    - nix run nixpkgs#statix -- check .
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Dead code detection with deadnix
nix:deadnix:
  extends: .nix-check-base
  script:
    - echo "Running deadnix..."
    - nix run nixpkgs#deadnix -- --fail .
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Format check
nix:format:
  extends: .nix-check-base
  script:
    - echo "Checking Nix formatting..."
    # treefmt doesn't support --check flag; run formatter and check for changes
    - nix fmt .
    - |
      if ! git diff --exit-code; then
        echo "ERROR: Files are not properly formatted. Run 'nix fmt' locally."
        exit 1
      fi
      echo "All files are properly formatted"
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# Validate flake inputs are up to date
nix:flake-update-check:
  extends: .nix-check-base
  script:
    - echo "Checking for flake input updates..."
    - nix flake update --dry-run 2>&1 | tee flake-update.log
    - |
      if grep -q "Updated" flake-update.log; then
        echo "INFO: Flake inputs have available updates"
        cat flake-update.log
      else
        echo "INFO: All flake inputs are up to date"
      fi
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "schedule"
  artifacts:
    paths:
      - flake-update.log
    expire_in: 1 week
