# Bazel Build Jobs
# ================
#
# These jobs validate Bazel builds work alongside Nix.
# Bazel is used for validation and artifact bundling, while Nix
# handles all binary and container builds.
#
# Uses Debian (glibc) because Bazelisk downloads a glibc-linked Bazel
# binary at runtime. Alpine (musl) causes "no such file or directory".

.bazel-base:
  stage: build
  image: debian:bookworm-slim
  tags:
    - nix
  interruptible: true
  variables:
    NIX_CONFIG: "experimental-features = nix-command flakes"
  cache:
    key: bazel-${CI_COMMIT_REF_SLUG}
    paths:
      - ~/.cache/bazel/
  before_script:
    - apt-get update -qq && apt-get install -y -qq curl xz-utils git ca-certificates python3 > /dev/null
    - chmod 755 /nix 2>/dev/null || true
    - curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install linux --no-confirm --init none
    - . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
    - nix develop .#ci --command bazel version
    - |
      if [ -n "${BAZEL_REMOTE_CACHE:-}" ]; then
        echo "Configuring remote cache: ${BAZEL_REMOTE_CACHE}"
        cat >> user.bazelrc << EOF
      build --config=ci
      build --remote_cache=${BAZEL_REMOTE_CACHE}
      build --remote_upload_local_results=true
      build --remote_download_minimal
      build --experimental_remote_cache_async
      build --remote_timeout=60
      EOF
      else
        echo "Remote cache not configured, using local disk cache"
        echo "build --config=ci" >> user.bazelrc
      fi

# =============================================================================
# Validation Jobs
# =============================================================================

# Validate Bazel configuration and query all targets
bazel:validate:
  extends: .bazel-base
  stage: validate
  script:
    - echo "Validating Bazel configuration..."
    - nix develop .#ci --command bazel info
    - nix develop .#ci --command bazel query //...
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# Validate buildifier formatting
bazel:format:
  extends: .bazel-base
  stage: validate
  script:
    - echo "Checking Bazel file formatting..."
    # buildifier is provided by the Nix devShell
    - nix develop .#ci --command buildifier -mode=check -r .
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# =============================================================================
# Build Jobs
# =============================================================================

# Build all Bazel targets (validation and bundling)
bazel:build:
  extends: .bazel-base
  needs: []  # Greedy: run immediately, don't wait for validate stage
  script:
    - echo "Building Bazel targets..."
    # Build deployment bundle and manifests
    - nix develop .#ci --command bazel build //:deployment_bundle
    - nix develop .#ci --command bazel build //:k8s_manifests
    - nix develop .#ci --command bazel build //:nix_files
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  artifacts:
    paths:
      - bazel-bin/
    expire_in: 1 day

# =============================================================================
# Test Jobs
# =============================================================================

# Run Bazel tests (config validation)
bazel:test:
  extends: .bazel-base
  stage: test
  needs: []  # Greedy: run immediately, don't wait for validate stage
  script:
    - echo "Running Bazel tests..."
    - nix develop .#ci --command bazel test //tests:config_validation //app:unit_tests --test_output=all
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# =============================================================================
# Affected Target Analysis (Incremental Validation)
# =============================================================================
# Only validate changed OpenTofu modules to improve CI performance.
# Uses git diff to detect changed files and maps them to Bazel targets.

# Validate only affected OpenTofu modules
bazel:affected-modules:
  extends: .bazel-base
  stage: validate
  script:
    - |
      echo "=== Affected OpenTofu Module Analysis ==="

      # Get the base commit (merge base with main)
      BASE_COMMIT=$(git merge-base origin/${CI_DEFAULT_BRANCH:-main} HEAD 2>/dev/null || echo "HEAD~1")
      echo "Base commit: ${BASE_COMMIT}"
      echo "Head commit: ${CI_COMMIT_SHA}"

      # Get changed .tf files
      CHANGED_FILES=$(git diff --name-only ${BASE_COMMIT} HEAD -- 'tofu/modules/**/*.tf' 2>/dev/null || true)

      if [ -z "$CHANGED_FILES" ]; then
        echo "No OpenTofu module changes detected, skipping validation"
        exit 0
      fi

      echo ""
      echo "Changed OpenTofu files:"
      echo "$CHANGED_FILES"
      echo ""

      # Extract unique module names from changed files
      AFFECTED_MODULES=$(echo "$CHANGED_FILES" | \
        grep -oP 'tofu/modules/\K[^/]+' | \
        sort -u | \
        tr '\n' ' ')

      echo "Affected modules: ${AFFECTED_MODULES}"
      echo ""

      # Build validation targets for affected modules
      VALIDATION_TARGETS=""
      for module in $AFFECTED_MODULES; do
        # Convert kebab-case to snake_case for Bazel target names
        target_name=$(echo "$module" | tr '-' '_')
        VALIDATION_TARGETS="${VALIDATION_TARGETS} //tofu/modules:${target_name}_validate"
      done

      if [ -n "$VALIDATION_TARGETS" ]; then
        echo "Running validation for:${VALIDATION_TARGETS}"
        nix develop .#ci --command bazel build $VALIDATION_TARGETS || {
          echo "ERROR: Module validation failed"
          exit 1
        }
        echo ""
        echo "=== All affected modules validated successfully ==="
      fi
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - tofu/modules/**/*.tf
  allow_failure: false

# Format check only affected OpenTofu modules
bazel:affected-fmt:
  extends: .bazel-base
  stage: validate
  script:
    - |
      echo "=== Affected OpenTofu Format Check ==="

      BASE_COMMIT=$(git merge-base origin/${CI_DEFAULT_BRANCH:-main} HEAD 2>/dev/null || echo "HEAD~1")

      # Get changed .tf files
      CHANGED_FILES=$(git diff --name-only ${BASE_COMMIT} HEAD -- 'tofu/modules/**/*.tf' 2>/dev/null || true)

      if [ -z "$CHANGED_FILES" ]; then
        echo "No OpenTofu module changes detected, skipping format check"
        exit 0
      fi

      # Extract unique module names
      AFFECTED_MODULES=$(echo "$CHANGED_FILES" | \
        grep -oP 'tofu/modules/\K[^/]+' | \
        sort -u | \
        tr '\n' ' ')

      echo "Checking formatting for modules: ${AFFECTED_MODULES}"

      # Run tofu fmt check on affected modules
      FAILED=0
      for module in $AFFECTED_MODULES; do
        echo ""
        echo "Checking: tofu/modules/${module}"
        if ! nix develop .#ci --command tofu fmt -check -recursive "tofu/modules/${module}" 2>&1; then
          FAILED=1
        fi
      done

      if [ $FAILED -eq 1 ]; then
        echo ""
        echo "ERROR: Some modules need formatting. Run: tofu fmt -recursive tofu/modules/"
        exit 1
      fi

      echo ""
      echo "=== All affected modules properly formatted ==="
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - tofu/modules/**/*.tf
  allow_failure: false
