# CI/CD pipeline jobs for bates-ils-runners deployment
# Deploys runner fleet to beehive (dev) and rigel (staging/prod)

.runners_deploy_base:
  extends: .tofu_with_k8s_tools
  stage: deploy
  variables:
    STACK_DIR: tofu/stacks/bates-ils-runners

.runners_init: &runners_init
  - cd ${STACK_DIR}
  - |
    tofu init -reconfigure \
      -backend-config="address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${STATE_NAME}" \
      -backend-config="lock_address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${STATE_NAME}/lock" \
      -backend-config="unlock_address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${STATE_NAME}/lock" \
      -backend-config="lock_method=POST" \
      -backend-config="unlock_method=DELETE" \
      -backend-config="username=gitlab-ci-token" \
      -backend-config="password=${CI_JOB_TOKEN}"

# ---------------------------------------------------------------------------
# Plan jobs - run on merge requests
# ---------------------------------------------------------------------------

runners:plan:beehive:
  extends: .runners_deploy_base
  variables:
    STATE_NAME: bates-ils-runners-beehive
  script:
    - *runners_init
    - tofu plan -var-file=beehive.tfvars -out=plan.tfplan
  artifacts:
    paths:
      - ${STACK_DIR}/plan.tfplan
    expire_in: 7 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - tofu/stacks/bates-ils-runners/**/*
        - tofu/modules/gitlab-runner/**/*

runners:plan:rigel:
  extends: .runners_deploy_base
  variables:
    STATE_NAME: bates-ils-runners-rigel
  script:
    - *runners_init
    - tofu plan -var-file=rigel.tfvars -out=plan.tfplan
  artifacts:
    paths:
      - ${STACK_DIR}/plan.tfplan
    expire_in: 7 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - tofu/stacks/bates-ils-runners/**/*
        - tofu/modules/gitlab-runner/**/*

# ---------------------------------------------------------------------------
# Apply jobs - manual, only on main branch
# ---------------------------------------------------------------------------

runners:apply:beehive:
  extends: .runners_deploy_base
  variables:
    STATE_NAME: bates-ils-runners-beehive
  script:
    - *runners_init
    - tofu apply -var-file=beehive.tfvars -auto-approve
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - tofu/stacks/bates-ils-runners/**/*
        - tofu/modules/gitlab-runner/**/*
      when: manual
  environment:
    name: beehive/runners

runners:apply:rigel:
  extends: .runners_deploy_base
  variables:
    STATE_NAME: bates-ils-runners-rigel
  script:
    - *runners_init
    - tofu apply -var-file=rigel.tfvars -auto-approve
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      changes:
        - tofu/stacks/bates-ils-runners/**/*
        - tofu/modules/gitlab-runner/**/*
      when: manual
  environment:
    name: rigel/runners
