# CI/CD pipeline jobs for GitLab runner deployment
# Deploys runner fleet to dev and staging/prod clusters

.runners_deploy_base:
  extends: .tofu_with_k8s_tools
  stage: deploy
  variables:
    STACK_DIR: tofu/stacks/gitlab-runners
    RUNNERS_NAMESPACE: "gitlab-runners"  # Override in CI/CD variables

# Shared init script — parameterized by STATE_NAME
.runners_init: &runners_init |
  cd ${STACK_DIR}
  tofu init -reconfigure \
    -backend-config="address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${STATE_NAME}" \
    -backend-config="lock_address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${STATE_NAME}/lock" \
    -backend-config="unlock_address=${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/terraform/state/${STATE_NAME}/lock" \
    -backend-config="lock_method=POST" \
    -backend-config="unlock_method=DELETE" \
    -backend-config="username=gitlab-ci-token" \
    -backend-config="password=${CI_JOB_TOKEN}"

# ---------------------------------------------------------------------------
# Plan jobs - run on merge requests
# ---------------------------------------------------------------------------

runners:plan:dev:
  extends: .runners_deploy_base
  variables:
    STATE_NAME: runners-dev
    KUBE_CONTEXT: $REVIEW_CLUSTER_CONTEXT
  script:
    - *runners_init
    - |
      PLAN_FLAGS=(-var-file=beehive.tfvars)
      if [ -n "${GITLAB_RUNNER_TOKEN:-}" ]; then
        PLAN_FLAGS+=(-var="gitlab_token=${GITLAB_RUNNER_TOKEN}")
      fi
      if [ -n "${KUBECONFIG:-}" ]; then
        PLAN_FLAGS+=(-var="k8s_config_path=${KUBECONFIG}")
      fi
      tofu plan "${PLAN_FLAGS[@]}" -out=plan.tfplan
  artifacts:
    paths:
      - ${STACK_DIR}/plan.tfplan
    expire_in: 7 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
  environment:
    name: dev/runners
    action: prepare

# prod plan — disabled until dev is validated and promoted
# runners:plan:prod:
#   extends: .runners_deploy_base
#   variables:
#     STATE_NAME: runners-prod
#     KUBE_CONTEXT: $STAGING_CLUSTER_CONTEXT
#   script:
#     - *runners_init
#     - tofu plan -var-file=prod.tfvars -var="gitlab_token=${GITLAB_RUNNER_TOKEN:-${CI_JOB_TOKEN}}" -out=plan.tfplan
#   artifacts:
#     paths:
#       - ${STACK_DIR}/plan.tfplan
#     expire_in: 7 days
#   rules:
#     - if: $CI_PIPELINE_SOURCE == "merge_request_event"

# ---------------------------------------------------------------------------
# Apply jobs - manual, only on main branch
# ---------------------------------------------------------------------------

runners:apply:dev:
  extends: .runners_deploy_base
  variables:
    STATE_NAME: runners-dev
    KUBE_CONTEXT: $REVIEW_CLUSTER_CONTEXT
  script:
    - *runners_init
    - |
      APPLY_FLAGS=(-var-file=beehive.tfvars -auto-approve)
      if [ -n "${GITLAB_RUNNER_TOKEN:-}" ]; then
        APPLY_FLAGS+=(-var="gitlab_token=${GITLAB_RUNNER_TOKEN}")
      fi
      if [ -n "${KUBECONFIG:-}" ]; then
        APPLY_FLAGS+=(-var="k8s_config_path=${KUBECONFIG}")
      fi
      tofu apply "${APPLY_FLAGS[@]}"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
  environment:
    name: dev/runners
# prod apply — disabled until dev is validated and promoted
# runners:apply:prod:
#   extends: .runners_deploy_base
#   variables:
#     STATE_NAME: runners-prod
#     KUBE_CONTEXT: $STAGING_CLUSTER_CONTEXT
#   script:
#     - *runners_init
#     - tofu apply -var-file=prod.tfvars -var="gitlab_token=${GITLAB_RUNNER_TOKEN:-${CI_JOB_TOKEN}}" -auto-approve
#   rules:
#     - if: $CI_COMMIT_BRANCH == "main"
#       when: manual
#   environment:
#     name: prod/runners
