# Runner Cleanup CronJob
#
# NOTE: Replace ${RUNNER_NAMESPACE} with your actual runner namespace
#
# Automatically cleans up completed and failed job pods in the runner namespace.
#
# Features:
# - Cleans completed pods older than 1 hour
# - Cleans failed pods older than 6 hours
# - Runs every 15 minutes
# - Safe deletion with ignore-not-found
#
# Deploy with: kubectl apply -f cleanup-cronjob.yaml

apiVersion: batch/v1
kind: CronJob
metadata:
  name: runner-cleanup
  namespace: ${RUNNER_NAMESPACE}
  labels:
    app.kubernetes.io/name: runner-cleanup
    app.kubernetes.io/component: cleanup
    app.kubernetes.io/managed-by: kubectl
spec:
  schedule: "*/15 * * * *" # Every 15 minutes
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 3600
      template:
        metadata:
          labels:
            app.kubernetes.io/name: runner-cleanup
        spec:
          serviceAccountName: runner-cleanup
          restartPolicy: OnFailure
          containers:
            - name: cleanup
              image: bitnami/kubectl:1.29
              resources:
                requests:
                  cpu: 50m
                  memory: 64Mi
                limits:
                  cpu: 100m
                  memory: 128Mi
              command:
                - /bin/bash
                - -c
                - |
                  set -euo pipefail

                  NAMESPACE="${RUNNER_NAMESPACE}"
                  COMPLETED_AGE="1h"
                  FAILED_AGE="6h"

                  echo "=== Runner Cleanup Job ==="
                  echo "Namespace: ${NAMESPACE}"
                  echo "Time: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
                  echo ""

                  # Clean completed job pods
                  echo "Cleaning completed pods older than ${COMPLETED_AGE}..."
                  COMPLETED=$(kubectl get pods -n ${NAMESPACE} \
                    --field-selector=status.phase==Succeeded \
                    -o jsonpath='{.items[*].metadata.name}' 2>/dev/null || echo "")

                  if [ -n "${COMPLETED}" ]; then
                    for pod in ${COMPLETED}; do
                      # Check pod age
                      CREATED=$(kubectl get pod ${pod} -n ${NAMESPACE} \
                        -o jsonpath='{.metadata.creationTimestamp}' 2>/dev/null || echo "")
                      if [ -n "${CREATED}" ]; then
                        AGE_SECONDS=$(( $(date +%s) - $(date -d "${CREATED}" +%s 2>/dev/null || echo 0) ))
                        if [ ${AGE_SECONDS} -gt 3600 ]; then
                          echo "  Deleting completed pod: ${pod} (age: ${AGE_SECONDS}s)"
                          kubectl delete pod ${pod} -n ${NAMESPACE} --ignore-not-found || true
                        fi
                      fi
                    done
                  else
                    echo "  No completed pods found"
                  fi

                  echo ""

                  # Clean failed job pods
                  echo "Cleaning failed pods older than ${FAILED_AGE}..."
                  FAILED=$(kubectl get pods -n ${NAMESPACE} \
                    --field-selector=status.phase==Failed \
                    -o jsonpath='{.items[*].metadata.name}' 2>/dev/null || echo "")

                  if [ -n "${FAILED}" ]; then
                    for pod in ${FAILED}; do
                      # Check pod age
                      CREATED=$(kubectl get pod ${pod} -n ${NAMESPACE} \
                        -o jsonpath='{.metadata.creationTimestamp}' 2>/dev/null || echo "")
                      if [ -n "${CREATED}" ]; then
                        AGE_SECONDS=$(( $(date +%s) - $(date -d "${CREATED}" +%s 2>/dev/null || echo 0) ))
                        if [ ${AGE_SECONDS} -gt 21600 ]; then
                          echo "  Deleting failed pod: ${pod} (age: ${AGE_SECONDS}s)"
                          kubectl delete pod ${pod} -n ${NAMESPACE} --ignore-not-found || true
                        fi
                      fi
                    done
                  else
                    echo "  No failed pods found"
                  fi

                  echo ""

                  # Clean orphaned ci-job-* namespaces (from namespace_per_job)
                  echo "Cleaning orphaned ci-job-* namespaces older than 2 hours..."
                  for ns in $(kubectl get namespaces -o jsonpath='{.items[*].metadata.name}' 2>/dev/null | tr ' ' '\n' | grep '^ci-job-'); do
                    CREATED=$(kubectl get namespace ${ns} \
                      -o jsonpath='{.metadata.creationTimestamp}' 2>/dev/null || echo "")
                    if [ -n "${CREATED}" ]; then
                      AGE_SECONDS=$(( $(date +%s) - $(date -d "${CREATED}" +%s 2>/dev/null || echo 0) ))
                      PODS=$(kubectl get pods -n ${ns} --field-selector=status.phase==Running -o jsonpath='{.items[*].metadata.name}' 2>/dev/null || echo "")
                      if [ ${AGE_SECONDS} -gt 7200 ] && [ -z "${PODS}" ]; then
                        echo "  Deleting orphaned namespace: ${ns} (age: ${AGE_SECONDS}s)"
                        kubectl delete namespace ${ns} --ignore-not-found || true
                      fi
                    fi
                  done

                  echo ""
                  echo "=== Cleanup complete ==="

---
# ServiceAccount for cleanup job
apiVersion: v1
kind: ServiceAccount
metadata:
  name: runner-cleanup
  namespace: ${RUNNER_NAMESPACE}
  labels:
    app.kubernetes.io/name: runner-cleanup
    app.kubernetes.io/component: cleanup

---
# Role for pod management in runner namespace
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: runner-cleanup
  namespace: ${RUNNER_NAMESPACE}
  labels:
    app.kubernetes.io/name: runner-cleanup
    app.kubernetes.io/component: cleanup
rules:
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "delete"]

---
# RoleBinding for namespace-scoped pod cleanup
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: runner-cleanup
  namespace: ${RUNNER_NAMESPACE}
  labels:
    app.kubernetes.io/name: runner-cleanup
    app.kubernetes.io/component: cleanup
subjects:
  - kind: ServiceAccount
    name: runner-cleanup
    namespace: ${RUNNER_NAMESPACE}
roleRef:
  kind: Role
  name: runner-cleanup
  apiGroup: rbac.authorization.k8s.io

---
# ClusterRole for orphaned ci-job-* namespace cleanup
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: runner-cleanup-namespaces
  labels:
    app.kubernetes.io/name: runner-cleanup
    app.kubernetes.io/component: cleanup
rules:
  - apiGroups: [""]
    resources: ["namespaces"]
    verbs: ["get", "list", "delete"]
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list"]

---
# ClusterRoleBinding for namespace cleanup
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: runner-cleanup-namespaces
  labels:
    app.kubernetes.io/name: runner-cleanup
    app.kubernetes.io/component: cleanup
subjects:
  - kind: ServiceAccount
    name: runner-cleanup
    namespace: ${RUNNER_NAMESPACE}
roleRef:
  kind: ClusterRole
  name: runner-cleanup-namespaces
  apiGroup: rbac.authorization.k8s.io
