# Runner Cleanup CronJob
#
# Automatically cleans up completed and failed job pods in the bates-ils-runners namespace.
# Ported from crush-dots cleanup patterns to Kubernetes CronJobs.
#
# Features:
# - Cleans completed pods older than 1 hour
# - Cleans failed pods older than 6 hours
# - Runs every 15 minutes
# - Safe deletion with ignore-not-found
#
# Deploy with: kubectl apply -f cleanup-cronjob.yaml

apiVersion: batch/v1
kind: CronJob
metadata:
  name: runner-cleanup
  namespace: bates-ils-runners
  labels:
    app.kubernetes.io/name: runner-cleanup
    app.kubernetes.io/component: cleanup
    app.kubernetes.io/managed-by: kubectl
spec:
  schedule: "*/15 * * * *" # Every 15 minutes
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 3
  jobTemplate:
    spec:
      ttlSecondsAfterFinished: 3600
      template:
        metadata:
          labels:
            app.kubernetes.io/name: runner-cleanup
        spec:
          serviceAccountName: runner-cleanup
          restartPolicy: OnFailure
          containers:
            - name: cleanup
              image: bitnami/kubectl:1.29
              resources:
                requests:
                  cpu: 50m
                  memory: 64Mi
                limits:
                  cpu: 100m
                  memory: 128Mi
              command:
                - /bin/bash
                - -c
                - |
                  set -euo pipefail

                  NAMESPACE="bates-ils-runners"
                  COMPLETED_AGE="1h"
                  FAILED_AGE="6h"

                  echo "=== Runner Cleanup Job ==="
                  echo "Namespace: ${NAMESPACE}"
                  echo "Time: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
                  echo ""

                  # Clean completed job pods
                  echo "Cleaning completed pods older than ${COMPLETED_AGE}..."
                  COMPLETED=$(kubectl get pods -n ${NAMESPACE} \
                    --field-selector=status.phase==Succeeded \
                    -o jsonpath='{.items[*].metadata.name}' 2>/dev/null || echo "")

                  if [ -n "${COMPLETED}" ]; then
                    for pod in ${COMPLETED}; do
                      # Check pod age
                      CREATED=$(kubectl get pod ${pod} -n ${NAMESPACE} \
                        -o jsonpath='{.metadata.creationTimestamp}' 2>/dev/null || echo "")
                      if [ -n "${CREATED}" ]; then
                        AGE_SECONDS=$(( $(date +%s) - $(date -d "${CREATED}" +%s 2>/dev/null || echo 0) ))
                        if [ ${AGE_SECONDS} -gt 3600 ]; then
                          echo "  Deleting completed pod: ${pod} (age: ${AGE_SECONDS}s)"
                          kubectl delete pod ${pod} -n ${NAMESPACE} --ignore-not-found || true
                        fi
                      fi
                    done
                  else
                    echo "  No completed pods found"
                  fi

                  echo ""

                  # Clean failed job pods
                  echo "Cleaning failed pods older than ${FAILED_AGE}..."
                  FAILED=$(kubectl get pods -n ${NAMESPACE} \
                    --field-selector=status.phase==Failed \
                    -o jsonpath='{.items[*].metadata.name}' 2>/dev/null || echo "")

                  if [ -n "${FAILED}" ]; then
                    for pod in ${FAILED}; do
                      # Check pod age
                      CREATED=$(kubectl get pod ${pod} -n ${NAMESPACE} \
                        -o jsonpath='{.metadata.creationTimestamp}' 2>/dev/null || echo "")
                      if [ -n "${CREATED}" ]; then
                        AGE_SECONDS=$(( $(date +%s) - $(date -d "${CREATED}" +%s 2>/dev/null || echo 0) ))
                        if [ ${AGE_SECONDS} -gt 21600 ]; then
                          echo "  Deleting failed pod: ${pod} (age: ${AGE_SECONDS}s)"
                          kubectl delete pod ${pod} -n ${NAMESPACE} --ignore-not-found || true
                        fi
                      fi
                    done
                  else
                    echo "  No failed pods found"
                  fi

                  echo ""
                  echo "=== Cleanup complete ==="

---
# ServiceAccount for cleanup job
apiVersion: v1
kind: ServiceAccount
metadata:
  name: runner-cleanup
  namespace: bates-ils-runners
  labels:
    app.kubernetes.io/name: runner-cleanup
    app.kubernetes.io/component: cleanup

---
# Role for pod management
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: runner-cleanup
  namespace: bates-ils-runners
  labels:
    app.kubernetes.io/name: runner-cleanup
    app.kubernetes.io/component: cleanup
rules:
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "delete"]

---
# RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: runner-cleanup
  namespace: bates-ils-runners
  labels:
    app.kubernetes.io/name: runner-cleanup
    app.kubernetes.io/component: cleanup
subjects:
  - kind: ServiceAccount
    name: runner-cleanup
    namespace: bates-ils-runners
roleRef:
  kind: Role
  name: runner-cleanup
  apiGroup: rbac.authorization.k8s.io
