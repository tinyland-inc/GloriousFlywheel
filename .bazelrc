# Attic Cache - Bazel Configuration
# =================================

# Build settings
build --jobs=auto
build --verbose_failures

# Use platforms for cross-compilation
build --incompatible_enable_cc_toolchain_resolution

# Enable Bzlmod (MODULE.bazel)
common --enable_bzlmod

# Disk cache for local builds
build --disk_cache=~/.cache/bazel/attic-cache

# =============================================================================
# Nix Integration
# =============================================================================
# Container and binary builds are handled by Nix (nix build .#container)
# Bazel focuses on validation and artifact bundling

# Allow Nix builds to access network for fetching dependencies
build --sandbox_add_mount_pair=/nix

# Async remote cache for better performance
build --experimental_remote_cache_async

# Guard against concurrent changes during builds
build --experimental_guard_against_concurrent_changes

# =============================================================================
# Remote Cache Configuration (bazel-remote on MinIO)
# =============================================================================
# Cache configurations for different environments.
# All use the same bazel-remote backend but with different endpoints.

# CI-internal: For GitLab runners in the beehive cluster
# Uses cluster-internal gRPC endpoint (no TLS)
build:ci-internal --remote_cache=grpc://bazel-cache.attic-cache-dev.svc.cluster.local:9092
build:ci-internal --remote_upload_local_results=true
build:ci-internal --remote_download_minimal
build:ci-internal --experimental_remote_cache_async
build:ci-internal --remote_timeout=60

# Remote: For external access (campus network)
# Uses ingress endpoint with TLS
build:remote --remote_cache=grpcs://bazel-cache.beehive.bates.edu:443
build:remote --remote_upload_local_results=true
build:remote --remote_download_minimal
build:remote --experimental_remote_cache_async
build:remote --remote_timeout=120

# Read-only: For builds that should only read from cache
build:cache-readonly --remote_upload_local_results=false

# Disable remote cache (for debugging)
build:no-remote-cache --remote_cache=

# Test settings
test --test_output=errors
test --test_verbose_timeout_warnings

# Coverage
coverage --combined_report=lcov

# Stamping for release builds
build:release --stamp
build:release --workspace_status_command=./build/workspace_status.sh

# Debug configuration
build:debug --compilation_mode=dbg
build:debug --strip=never

# CI configuration (base settings)
build:ci --jobs=4
build:ci --disk_cache=
build:ci --color=yes
build:ci --curses=no
test:ci --test_output=all

# CI with remote cache (for beehive runners)
# Combines ci settings with ci-internal remote cache
build:ci-cached --config=ci
build:ci-cached --config=ci-internal

# Platform-specific settings (containers built via Nix, not rules_oci)
# build:linux --platforms=@platforms//os:linux
# build:macos --platforms=@platforms//os:macos

# Memory optimization for large builds
startup --host_jvm_args=-Xmx4g

# =============================================================================
# JavaScript / SvelteKit Build Settings
# =============================================================================
# Settings for rules_js and the Runner Dashboard app

# Allow pnpm/node to create symlinks in sandbox
build --experimental_allow_unresolved_symlinks

# Increase NodeJS heap for SvelteKit builds
build --action_env=NODE_OPTIONS=--max-old-space-size=4096

# Import user-specific settings if present
try-import %workspace%/user.bazelrc
